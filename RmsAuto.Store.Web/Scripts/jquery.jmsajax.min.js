; (function ($) {
    $.jmsajax = function (options) {
        var defaults = {
            type: "POST",
            //dataType: "msjson",
            data: {},
            beforeSend: function (xhr) { xhr.setRequestHeader("Content-type", "application/json; charset=utf-8"); },
            contentType: "application/json; charset=utf-8",
            error: function (x, s, m) { alert(x.responseText); }
        };
        var options = $.extend(defaults, options);

        if (options.method) {
            options.url += "/" + options.method;
        }

        if (options.data) {
            if (options.type == "GET") {
                var data = "";
                for (var i in options.data) {
                    if (data != "") data += "&";
                    data += i + "=" + JSON.stringify(options.data[i]);
                }
                options.url += "?" + data;
                data = null;
                options.data = "{}";
            } else if (options.type == "POST") {
                options.data = JSON.stringify(options.data);
            }
        }

        if (options.success) {
            if (options.dataType) {
                if (options.dataType == "msjson") {
                    var base = options.success;
                    options.success = function (response, status) {
                        var y = response;
                        if (y.d) {
                            y = JSON.parse(y.d, isoDateReviver);
                            base(y, status);
                        }
                    }
                }
            }
        }

        return $.ajax(options);
    };

    isoDateReviver = function (key, value) {
        if (typeof value === 'string') { var a = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)(?:([\+-])(\d{2})\:(\d{2}))?Z?$/.exec(value); if (a) { return new Date(+a[1], +a[2] - 1, +a[3], +a[4], +a[5]); } }
        return value;
    };
})(jQuery);